(function(b){b.widget("ui.audiobookpreview",{options:{type:{}},_an:{},_audioUrl:{},_audioElement:{},_playButton:{},_progressBar:{},_isPlaying:false,_create:function(){ep.debug("audiobookpreview:create");var a=this;this._an=b(this.element).data("an");this._playButton=b(this.element).find(".audio-sample");this._progressBar=b(this.element).find(".progress-indicator");this._audioUrl=b(this.element).data("src");if(this.options.type==="html5"){this._audioElement=b("<audio/>").attr("src",this._audioUrl)[0]}else{this._audioElement=swfobject.getObjectById("flashReplacement");try{this._audioElement.initFlash(this._audioUrl)}catch(d){a.destroy()}}b(document).bind("playAudio",function(c,f){if(f!==a._an&&a._audioElement){if(a.options.type==="html5"){a._stop()}else{a._playButton.removeClass("playing");a._progressBar.css({width:"0%"})}a.destroy()}})},_init:function(){ep.debug("audiobookpreview:init");if(this._audioElement){if(!this._isPlaying){b(document).trigger("playAudio",this._an);this._play()}else{this._pause()}}else{this.destroy()}},_play:function(){ep.debug("audiobookpreview:playing");if(this.options.type==="html5"){this._audioElement.play()}else{this._audioElement.playFlash()}this._isPlaying=true;this._playButton.addClass("playing");this._timeUpdate()},_pause:function(){ep.debug("audiobookpreview:paused");if(this.options.type==="html5"){this._audioElement.pause()}else{this._audioElement.pauseFlash()}this._isPlaying=false;this._playButton.removeClass("playing")},_stop:function(){this._pause();ep.debug("audiobookpreview:stopped");if(this.options.type==="html5"){this._audioElement.currentTime=0}else{this._audioElement.stopFlash()}this._progressBar.css({width:"0%"})},_timeUpdate:function(){if(this._isPlaying){var i,g;var h=false;if(this.options.type==="html5"){i=this._audioElement.duration;g=this._audioElement.currentTime;if(g>0&&g>=(i-0.1)){h=true}}else{i=this._audioElement.durationFlash();g=this._audioElement.currentTimeFlash();if(this._audioElement.isEndedFlash()){h=true}}var j=g/i;var a=j*100;this._progressBar.css({width:a+"%"});if(h){this._stop()}this._timer=setTimeout(b.proxy(this._timeUpdate,this),500)}else{clearTimeout(this._timer)}},destroy:function(){ep.debug("audiobookpreview:destory");b.Widget.prototype.destroy.call(this)}});b(function(){var a;if(Modernizr.audio&&Modernizr.audio.mp3){a="html5"}else{a="flash";b("body").append("<span id='flashReplacement'/>");swfobject.embedSWF(ep.baseImagePath+"flash/audiobookpreview.swf","flashReplacement","0","0","9.0.0","",{},{allowScriptAccess:"always"})}b(document).delegate(".audio-sample","click",function(d){b(this).parent().audiobookpreview({type:a});d.preventDefault()})})})(jQuery);